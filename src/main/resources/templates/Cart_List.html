<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- CSS -->
	<link rel="stylesheet" href="css/bootstrap-reboot.min.css">
	<link rel="stylesheet" href="css/bootstrap-grid.min.css">
	<link rel="stylesheet" href="css/owl.carousel.min.css">
	<link rel="stylesheet" href="css/magnific-popup.css">
	<link rel="stylesheet" href="css/select2.min.css">
	<link rel="stylesheet" href="css/paymentfont.min.css">
	<link rel="stylesheet" href="css/slider-radio.css">
	<link rel="stylesheet" href="css/plyr.css">
	<link rel="stylesheet" href="css/main.css">

	<!-- Favicons -->
	<link rel="icon" type="image/png" href="icon/favicon-32x32.png" sizes="32x32">
	<link rel="apple-touch-icon" href="icon/favicon-32x32.png">

	<meta name="description" content="">
	<meta name="keywords" content="">
	<meta name="author" content="Dmitry Volkov">
	<title>Volna – Record label & Music streaming HTML Template</title>

</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script th:if="${session.login eq null}">
	alert('로그인 이후 이용해주세요');
	location.href="memberLogin";
</script>
<body>
	<!-- header -->
	<header th:replace="header.html :: header"></header>
	<!-- end header -->

	<!-- sidebar -->
	<aside th:replace="sidebar.html :: aside"></aside>
	<!-- end sidebar -->

	<!-- main content -->
	<main class="main">
		<div class="container-fluid">
			<div class="row row--grid">
				<!-- breadcrumb -->
				<div class="col-12">
					<ul class="breadcrumb">
						<li class="breadcrumb__item"><a href="/index">Home</a></li>
						<li class="breadcrumb__item breadcrumb__item--active">Cart</li>
					</ul>
				</div>
				<!-- end breadcrumb -->

				<!-- title -->
				<div class="col-12">
					<div class="main__title main__title--page">
						<h1>Cart</h1>
					</div>
				</div>
				<!-- end title -->
			</div>

			<div class="row row--grid">
				<div class="col-12 col-lg-8">
					<!-- cart -->
					<div class="dashbox__list-wrap">
						<form method="post" action="/kakaoPay">
							<div class="dashbox__scroll" style="max-height: 500px;">
								<div class="scroll-content" id="cartListArea"></div>
							</div>
	
							<div class="cart__info">
								<div class="cart__total" id="totalAtea">
							</div>

							<!-- promo -->
							<span class="cart__promo" id="paybtnArea">
								
							</span>
							<!-- end promo -->

							<div class="cart__systems" id="payContentArea">
							</div>
						</div>
						</form>
					</div>
					<!-- end cart -->
				</div>

				<div class="col-12 col-lg-4">
					<!-- checkout -->
					<div class="dashbox">
						<div class="dashbox__title">
							<h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.65,2.24a1,1,0,0,0-.8-.23l-13,2A1,1,0,0,0,7,5V15.35A3.45,3.45,0,0,0,5.5,15,3.5,3.5,0,1,0,9,18.5V10.86L20,9.17v4.18A3.45,3.45,0,0,0,18.5,13,3.5,3.5,0,1,0,22,16.5V3A1,1,0,0,0,21.65,2.24ZM5.5,20A1.5,1.5,0,1,1,7,18.5,1.5,1.5,0,0,1,5.5,20Zm13-2A1.5,1.5,0,1,1,20,16.5,1.5,1.5,0,0,1,18.5,18ZM20,7.14,9,8.83v-3L20,4.17Z"/></svg> New Music</h3>
							<div class="dashbox__wrap">
								<a class="dashbox__refresh" href="#" id="refreshbtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10,0,0,0,5.12,4.77V3a1,1,0,0,0-2,0V7.5a1,1,0,0,0,1,1H8.62a1,1,0,0,0,0-2H6.22A8,8,0,1,1,4,12a1,1,0,0,0-2,0A10,10,0,1,0,12,2Zm0,6a1,1,0,0,0-1,1v3a1,1,0,0,0,1,1h2a1,1,0,0,0,0-2H13V9A1,1,0,0,0,12,8Z"/></svg></a>
								<a class="dashbox__more" href="/allfileList">View All</a>
							</div>
						</div>
						<div class="dashbox__list-wrap">
							<ul class="main__list main__list--dashbox" id="newMusicArea" style="height: 450px;">
							</ul>
						</div>
					</div>
					
					<!-- end checkout -->
				</div>
			</div>

			<!-- partners -->
			<div class="row">
				<div class="col-12">
					<div class="partners owl-carousel">
						<a href="#" class="partners__img">
							<img src="img/partners/3docean-light-background.png" alt="">
						</a>

						<a href="#" class="partners__img">
							<img src="img/partners/activeden-light-background.png" alt="">
						</a>

						<a href="#" class="partners__img">
							<img src="img/partners/audiojungle-light-background.png" alt="">
						</a>

						<a href="#" class="partners__img">
							<img src="img/partners/codecanyon-light-background.png" alt="">
						</a>

						<a href="#" class="partners__img">
							<img src="img/partners/photodune-light-background.png" alt="">
						</a>

						<a href="#" class="partners__img">
							<img src="img/partners/themeforest-light-background.png" alt="">
						</a>
					</div>
				</div>
			</div>
			<!-- end partners -->
		</div>
	</main>
	<!-- end main content -->

	<!-- footer -->
	<footer th:replace="footer.html :: footer"></footer>
	<!-- end footer -->

	<!-- modal info -->
	<div id="modal-info2" class="zoom-anim-dialog mfp-hide modal modal--info">
		<span class="modal__icon modal__icon--green">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.72,8.79l-4.29,4.3L8.78,11.44a1,1,0,1,0-1.41,1.41l2.35,2.36a1,1,0,0,0,.71.29,1,1,0,0,0,.7-.29l5-5a1,1,0,0,0,0-1.42A1,1,0,0,0,14.72,8.79ZM12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z"></path></svg>
		</span>
		
		<button class="modal__close" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.41,12l4.3-4.29a1,1,0,1,0-1.42-1.42L12,10.59,7.71,6.29A1,1,0,0,0,6.29,7.71L10.59,12l-4.3,4.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L12,13.41l4.29,4.3a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42Z"/></svg></button>

		<h4 class="sign__title">Payment #51 was successful!</h4>

		<div class="sign__group sign__group--row">
			<label class="sign__label">Total cost:</label>
			<span class="sign__value">$18.00</span>
		</div>

		<div class="sign__group sign__group--row">
			<label class="sign__label">Payment method: <b>Paypal</b></label>

			<span class="sign__text sign__text--small">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.</span>
		</div>
	</div>
	<!-- end modal info -->

	<!-- modal info -->
	<div id="modal-info3" class="zoom-anim-dialog mfp-hide modal modal--info">
		<span class="modal__icon modal__icon--red">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.71,8.29a1,1,0,0,0-1.42,0L12,10.59,9.71,8.29A1,1,0,0,0,8.29,9.71L10.59,12l-2.3,2.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L12,13.41l2.29,2.3a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42L13.41,12l2.3-2.29A1,1,0,0,0,15.71,8.29Zm3.36-3.36A10,10,0,1,0,4.93,19.07,10,10,0,1,0,19.07,4.93ZM17.66,17.66A8,8,0,1,1,20,12,7.95,7.95,0,0,1,17.66,17.66Z"></path></svg>
		</span>
		
		<button class="modal__close" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.41,12l4.3-4.29a1,1,0,1,0-1.42-1.42L12,10.59,7.71,6.29A1,1,0,0,0,6.29,7.71L10.59,12l-4.3,4.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L12,13.41l4.29,4.3a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42Z"/></svg></button>

		<h4 class="sign__title">Payment #50 failed!</h4>

		<div class="sign__group sign__group--row">
			<label class="sign__label">Total cost:</label>
			<span class="sign__value">$18.00</span>
		</div>

		<div class="sign__group sign__group--row">
			<label class="sign__label">Payment method: <b>Paypal</b></label>

			<span class="sign__text sign__text--small">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.</span>
		</div>
	</div>
	<!-- end modal info -->

	<!-- modal info -->
	<div id="modal-info4" class="zoom-anim-dialog mfp-hide modal modal--info">
		<span class="modal__icon">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10,0,1,0,22,12,10.01114,10.01114,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8.00917,8.00917,0,0,1,12,20Zm0-8.5a1,1,0,0,0-1,1v3a1,1,0,0,0,2,0v-3A1,1,0,0,0,12,11.5Zm0-4a1.25,1.25,0,1,0,1.25,1.25A1.25,1.25,0,0,0,12,7.5Z"></path></svg>
		</span>
		
		<button class="modal__close" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.41,12l4.3-4.29a1,1,0,1,0-1.42-1.42L12,10.59,7.71,6.29A1,1,0,0,0,6.29,7.71L10.59,12l-4.3,4.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L12,13.41l4.29,4.3a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42Z"/></svg></button>

		<h4 class="sign__title">Example of notification.</h4>

		<div class="sign__group sign__group--row">
			<label class="sign__label">Amount to auto-renew:</label>
			<span class="sign__value">$18.00</span>
		</div>

		<div class="sign__group sign__group--row">
			<span class="sign__text sign__text--small">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.</span>
		</div>
	</div>
	<!-- end modal info -->

	<!-- modal info -->
	<div id="modal-info5" class="zoom-anim-dialog mfp-hide modal modal--info">
		<span class="modal__icon modal__icon--purple">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18,7h-.35A3.45,3.45,0,0,0,18,5.5a3.49,3.49,0,0,0-6-2.44A3.49,3.49,0,0,0,6,5.5,3.45,3.45,0,0,0,6.35,7H6a3,3,0,0,0-3,3v2a1,1,0,0,0,1,1H5v6a3,3,0,0,0,3,3h8a3,3,0,0,0,3-3V13h1a1,1,0,0,0,1-1V10A3,3,0,0,0,18,7ZM11,20H8a1,1,0,0,1-1-1V13h4Zm0-9H5V10A1,1,0,0,1,6,9h5Zm0-4H9.5A1.5,1.5,0,1,1,11,5.5Zm2-1.5A1.5,1.5,0,1,1,14.5,7H13ZM17,19a1,1,0,0,1-1,1H13V13h4Zm2-8H13V9h5a1,1,0,0,1,1,1Z"></path></svg>
		</span>
		
		<button class="modal__close" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.41,12l4.3-4.29a1,1,0,1,0-1.42-1.42L12,10.59,7.71,6.29A1,1,0,0,0,6.29,7.71L10.59,12l-4.3,4.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L12,13.41l4.29,4.3a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42Z"/></svg></button>

		<h4 class="sign__title">You have received a gift!</h4>

		<div class="sign__group sign__group--row">
			<span class="sign__text sign__text--small">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.</span>

			<span class="sign__text sign__text--small">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.</span>
		</div>
	</div>
	<!-- end modal info -->

	<!-- JS -->
	<script src="js/jquery-3.5.1.min.js"></script>
	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/owl.carousel.min.js"></script>
	<script src="js/jquery.magnific-popup.min.js"></script>
	<script src="js/smooth-scrollbar.js"></script>
	<script src="js/select2.min.js"></script>
	<script src="js/slider-radio.js"></script>
	<script src="js/jquery.inputmask.min.js"></script>
	<script src="js/plyr.min.js"></script>
	<script src="js/main.js"></script>
</body>

<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<script type="text/javascript" th:inline="javascript">
	var CheckLogin = [[${session.login}]]
	
	if(CheckLogin != null){
		var sessionId = [[${session.login.mId}]]
	}
	
	$(document).ready(function(){
		$.ajax({
			type : "POST",
			url : "ajaxCartList",
			data : {"caMid" : sessionId},
			dataType : "json",
			success : function(list){
				cartList(list);
			},
			error : function(){
				alert("실패");
			}
		});
		
		$.ajax({
			type : "POST",
			url : "ajaxFileList",
			dataType : "json",
			success : function(data){
				var music = data.musicList;
				
				var output = "";
				
				for(var i in music){
					output += "<li class='single-item'>";
					output += "<a data-link data-title='"+music[i].muName+"' data-artist='"+music[i].muSinger+"' data-img='/muImage/"+music[i].muImage+"' href='https://dmitryvolkov.me/demo/blast2.0/audio/12071151_epic-cinematic-trailer_by_audiopizza_preview.mp3' class='single-item__cover'>";
					output += "<img src='/muImage/"+music[i].muImage+"' style='height:45px;'>";
					output += "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M18.54,9,8.88,3.46a3.42,3.42,0,0,0-5.13,3V17.58A3.42,3.42,0,0,0,7.17,21a3.43,3.43,0,0,0,1.71-.46L18.54,15a3.42,3.42,0,0,0,0-5.92Zm-1,4.19L7.88,18.81a1.44,1.44,0,0,1-1.42,0,1.42,1.42,0,0,1-.71-1.23V6.42a1.42,1.42,0,0,1,.71-1.23A1.51,1.51,0,0,1,7.17,5a1.54,1.54,0,0,1,.71.19l9.66,5.58a1.42,1.42,0,0,1,0,2.46Z'/></svg>"
					output += "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M16,2a3,3,0,0,0-3,3V19a3,3,0,0,0,6,0V5A3,3,0,0,0,16,2Zm1,17a1,1,0,0,1-2,0V5a1,1,0,0,1,2,0ZM8,2A3,3,0,0,0,5,5V19a3,3,0,0,0,6,0V5A3,3,0,0,0,8,2ZM9,19a1,1,0,0,1-2,0V5A1,1,0,0,1,9,5Z'/></svg></a>"
					
					output += "<div class='single-item__title'>"
					output += "<h4><a href='muView?muCode="+music[i].muCode+"&mId="+music[i].muSinger+"'>"+music[i].muName+"</a></h4>";
					output += "<span><a href='boardWriterView?boWriter="+music[i].muSinger+"&mId="+sessionId+"'>"+music[i].muSinger+"</a></span>";
					output += "</div></li>";
				}
				
				var newMusicArea = document.getElementById('newMusicArea');
				newMusicArea.innerHTML = output;

			},
			error : function(){
				alert('음악목록 실패');
			}
		});
		
		function cartList(list){
			var output = "";
			var output1 = "";
			var output2 = "";
			var output3 = "";
			var muprice = $(list).length;
			
			if(muprice <= 0){
				output += "<table class='cart__table'>";
				output += "<tr>";
				output += "<th>장바구니가 비어있습니다.<br/><a href='/allfileList' class='hero__btn hero__btn--green'>음원목록으로</a></th>";
				output += "</tr>";
			} else{
				output += "<table class='cart__table'>";
				output += "<thead>"
				output += "<tr>";
				output += "<th>프로필</th>";
				output += "<th>제목</th>";
				output += "<th>가수</th>";
				output += "<th>좋아요</th>";
				output += "<th>조회수</th>";
				output += "<th>금액</th>";
				output += "<th></th>";
				output += "</tr>";
				output += "</thead>"
			}
			
			for(var i in list){
				output += "<tbody>"
				output += "<tr>";
				output += "<td><img src='/muImage/"+list[i].muImage+"' style='width: 70px; height: 70px; border-radius: 70%; overflow: hidden;'></td>";
				output += "<td><a href='muView?muCode="+list[i].muCode+"&mId="+list[i].muSinger+"'><span id='"+list[i].muCode+"' class='cartMusicName' value='"+list[i].muSinger+"' name='"+list[i].muName+"'>"+list[i].muName+"</span></a></td>";
				output += "<td>"+list[i].muSinger+"</td>";
				output += "<td>"+list[i].muLike+"</td>";
				output += "<td>"+list[i].muHit+"</td>";
				output += "<td>500원</td>";
				output += "<td><button id='"+list[i].muCode+"' class='cart__delete' type='button'><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M13.41,12l6.3-6.29a1,1,0,1,0-1.42-1.42L12,10.59,5.71,4.29A1,1,0,0,0,4.29,5.71L10.59,12l-6.3,6.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L12,13.41l6.29,6.3a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42Z'></path></svg></button></td>"
				output += "</tr>";
				output += "</tbodt>"
			}
			
			if(muprice <= 0){
				output += "</table>";
			} else{
				output1 += "<div>";
				output1 += "<p>총금액</p>";
				output1 += "<span colspan = 5 name='price' value='"+muprice * 500+"' id='totalPrice' class='cart__total'>"+muprice * 500+"원</span></div>";
				output2 += "<span class='sign__group sign__group--checkbox'><input id='remember' name='remember' type='checkbox'>";
				output2 += "<label for='remember'>구매 <a href='privacy.html'>이용약관</a> 동의<br/>(필수)</label>";
				output2 += "</span>";
				output2 += "<span><button id='check_module' type='button' class='sign__btn'>결제하기</button></span>";
				output3 += "<i><img src='/icon/payment_icon_yellow_small.png' style='width: 60px; opacity: 0.6;'></i>"
				output += "</table>";
			}
			
			var cartListArea = document.getElementById('cartListArea');
			cartListArea.innerHTML = output;
			
			var totalAtea = document.getElementById('totalAtea');
			totalAtea.innerHTML = output1;
			
			var paybtnArea = document.getElementById('paybtnArea');
			paybtnArea.innerHTML = output2;
			
			var payContentArea = document.getElementById('payContentArea');
			payContentArea.innerHTML = output3;
			
			var cartMusicName = document.getElementsByClassName('cartMusicName');
			
			var firstCartMusicName = $('.cartMusicName').attr('name');
				
			console.log(firstCartMusicName);
			
			
			$(".cart__delete").click(function(){
				
				var muCode = $(this).attr('id');
				console.log("muCode : "+muCode);
				
				$.ajax({
					type : "POST",
					url : "cartListDelete",
					data : {"caMuCode" : muCode,
							"caMid" : sessionId
							},
					dataType : "json",
					success : function(list){
						cartList(list);
					},
					error : function(){
						alert('장바구니 삭제 실패');
					}
				});
				
			});
			
			$("#check_module").click(function () {
				
				if($("#remember").is(':checked') == true){
					var IMP = window.IMP; // 생략가능
					IMP.init('imp58457377');
					// 'iamport' 대신 부여받은 "가맹점 식별코드"를 사용
					// i'mport 관리자 페이지 -> 내정보 -> 가맹점식별코드
					IMP.request_pay({
						pg: 'inicis', // version 1.1.0부터 지원.
						/*
						'kakao':카카오페이,
						html5_inicis':이니시스(웹표준결제)
							'nice':나이스페이
							'jtnet':제이티넷
							'uplus':LG유플러스
							'danal':다날
							'payco':페이코
							'syrup':시럽페이
							'paypal':페이팔
						*/
					pay_method: 'card',
						/*
						'samsung':삼성페이,
						'card':신용카드,
						'trans':실시간계좌이체,
						'vbank':가상계좌,
						'phone':휴대폰소액결제
						*/
					merchant_uid: 'merchant_' + new Date().getTime(),
						/*
						merchant_uid에 경우
						https://docs.iamport.kr/implementation/payment
						위에 url에 따라가시면 넣을 수 있는 방법이 있습니다.
						참고하세요.
						나중에 포스팅 해볼게요.
						*/
						
					name: '노래제목:'+firstCartMusicName+' 외'+ (muprice-1) +'곡',
					//결제창에서 보여질 이름
					
					amount: muprice * 500,
					//가격
					
					buyer_email: 'iamport@siot.do',
					buyer_name: sessionId,
					buyer_tel: '010-1234-5678',
					buyer_addr: '서울특별시 강남구 삼성동',
					buyer_postcode: '123-456',
					m_redirect_url: 'https://www.yourdomain.com/payments/complete'
						/*
						모바일 결제시,
						결제가 끝나고 랜딩되는 URL을 지정
						(카카오페이, 페이코, 다날의 경우는 필요없음. PC와 마찬가지로 callback함수로 결과가 떨어짐)
						*/
					}, function (rsp) {
						console.log(rsp);
						if (rsp.success) {
							var msg = '결제가 완료되었습니다.';
							msg += '고유ID : ' + rsp.imp_uid;
							msg += '상점 거래ID : ' + rsp.merchant_uid;
							msg += '결제 금액 : ' + rsp.paid_amount;
							msg += '카드 승인번호 : ' + rsp.apply_num;
							
							$('.cartMusicName').each(function(){
								var cartMusicCode = $(this).attr('id');
								var cartMusicSinger = $(this).attr('value');
								console.log(cartMusicCode);
								console.log(cartMusicSinger);
								console.log(sessionId);
								
								$.ajax({
									type: "POST",
									url: "payInsert",
									data: { "pMuCode" : cartMusicCode,
											"pbMid" : cartMusicSinger,
											"psMid" : sessionId},
									dataType : "json",
									async: false,
									success : function(list){
										cartList(list);
										$("#cartCountArea").load(window.location.href + "#cartCountArea");
									},
									error : function(){
										console.log('결제테이블 등록 실패');
									}
								});
							});
							
						} else {
							var msg = '결제에 실패하였습니다.';
							msg += '에러내용 : ' + rsp.error_msg;
						}
						alert(msg);
					});
				} else if($("#remember").is(':checked') == false){
					alert("약관 동의 후 구매 가능합니다.");
				}
			});
		}
	});
	
	$("#refreshbtn").click(function(){
		location.reload();
	});
	
</script>
</html>